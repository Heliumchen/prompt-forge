<!DOCTYPE html>
<html>
<head>
    <title>Debug Variable Sync</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .code { background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Debug Variable Sync</h1>
    
    <div class="section">
        <h2>Step 1: Check Test Set Data</h2>
        <button onclick="checkTestSetData()">Check Test Set Data</button>
        <div id="testSetResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Check Project Data</h2>
        <button onclick="checkProjectData()">Check Project Data</button>
        <div id="projectResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: Extract Variables from Prompts</h2>
        <button onclick="extractVariables()">Extract Variables</button>
        <div id="variableResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 4: Test Synchronization</h2>
        <button onclick="testSync()">Test Sync</button>
        <div id="syncResult"></div>
    </div>

    <script>
        function checkTestSetData() {
            const testSets = JSON.parse(localStorage.getItem('prompt-forge-test-sets') || '[]');
            const result = document.getElementById('testSetResult');
            
            if (testSets.length === 0) {
                result.innerHTML = '<div class="error">No test sets found</div>';
                return;
            }
            
            const testSet = testSets[0]; // 使用第一个test set
            result.innerHTML = `
                <div class="success">Test Set Found:</div>
                <div class="code">${JSON.stringify(testSet, null, 2)}</div>
            `;
        }
        
        function checkProjectData() {
            const projects = JSON.parse(localStorage.getItem('prompt-forge-projects') || '[]');
            const result = document.getElementById('projectResult');
            
            if (projects.length === 0) {
                result.innerHTML = '<div class="error">No projects found</div>';
                return;
            }
            
            // 找到关联的project
            const testSets = JSON.parse(localStorage.getItem('prompt-forge-test-sets') || '[]');
            if (testSets.length === 0) {
                result.innerHTML = '<div class="error">No test sets found to get associated project</div>';
                return;
            }
            
            const testSet = testSets[0];
            const project = projects.find(p => p.uid === testSet.associatedProjectUid);
            
            if (!project) {
                result.innerHTML = '<div class="error">Associated project not found</div>';
                return;
            }
            
            result.innerHTML = `
                <div class="success">Associated Project Found:</div>
                <div class="code">Project: ${project.name}
Versions: ${project.versions.length}
Current Version: ${project.currentVersion}

Versions Details:
${project.versions.map(v => `
Version ${v.id}:
  Prompts: ${v.data.prompts ? v.data.prompts.length : 0}
  ${v.data.prompts ? v.data.prompts.map(p => `
    Role: ${p.role}
    Content: ${p.content.substring(0, 100)}...`).join('') : 'No prompts'}
`).join('')}</div>
            `;
        }
        
        function extractVariables() {
            const projects = JSON.parse(localStorage.getItem('prompt-forge-projects') || '[]');
            const testSets = JSON.parse(localStorage.getItem('prompt-forge-test-sets') || '[]');
            const result = document.getElementById('variableResult');
            
            if (testSets.length === 0 || projects.length === 0) {
                result.innerHTML = '<div class="error">Missing test sets or projects</div>';
                return;
            }
            
            const testSet = testSets[0];
            const project = projects.find(p => p.uid === testSet.associatedProjectUid);
            
            if (!project) {
                result.innerHTML = '<div class="error">Associated project not found</div>';
                return;
            }
            
            // 提取每个version的variables
            const variablePattern = /\{\{([a-zA-Z_][a-zA-Z0-9_]*)\}\}/g;
            
            const versionVariables = project.versions.map(version => {
                const variables = new Set();
                
                if (version.data.prompts) {
                    version.data.prompts.forEach(prompt => {
                        if (prompt.content) {
                            let match;
                            variablePattern.lastIndex = 0;
                            while ((match = variablePattern.exec(prompt.content)) !== null) {
                                variables.add(match[1]);
                            }
                        }
                    });
                }
                
                return {
                    versionId: version.id,
                    variables: Array.from(variables)
                };
            });
            
            result.innerHTML = `
                <div class="success">Variables extracted from each version:</div>
                <div class="code">${JSON.stringify(versionVariables, null, 2)}</div>
            `;
        }
        
        function testSync() {
            const result = document.getElementById('syncResult');
            result.innerHTML = '<div class="warning">Manual sync test - check console for details</div>';
            
            // 这里你需要手动测试同步逻辑
            console.log('Test sync function called - check the extracted variables above and manually test sync');
        }
    </script>
</body>
</html>